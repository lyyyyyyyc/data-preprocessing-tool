<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据预处理在线工具</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 1200px;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 20px 20px 0 0;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            margin: 30px;
            transition: all 0.3s ease;
            background: #f8f9fa;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #e9ecef;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 30px;
            color: white;
            transition: all 0.3s ease;
        }
        
        .function-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .hidden {
            display: none;
        }
        
        .data-info {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
        }
        
        .result-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .result-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .code-display {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .nav-pills .nav-link {
            border-radius: 25px;
            margin: 0 5px;
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- 头部 -->
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> 数据预处理在线工具</h1>
                <p>轻松处理您的Excel数据 - 缺失值、异常值、标准化、统计分析一站式解决</p>
            </div>

            <!-- 文件上传区域 -->
            <div id="upload-section">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 4rem; color: #667eea; margin-bottom: 20px;">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h4>点击选择Excel文件</h4>
                    <p class="text-muted">支持 .xlsx 和 .xls 格式，最大 16MB</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                    <button class="btn btn-custom mt-3" type="button">
                        <i class="fas fa-folder-open"></i> 选择文件
                    </button>
                </div>
            </div>

            <!-- 数据信息显示 -->
            <div id="data-info-section" class="hidden">
                <div class="data-info">
                    <h4><i class="fas fa-info-circle"></i> 数据信息</h4>
                    <div id="dataInfo"></div>
                </div>
            </div>

            <!-- 功能选择区域 -->
            <div id="functions-section" class="hidden">
                <div class="container">
                    <h4 class="text-center mb-4"><i class="fas fa-cogs"></i> 选择数据处理功能</h4>
                    
                    <!-- 功能标签页 -->
                    <ul class="nav nav-pills justify-content-center mb-4" id="functionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="preprocessing-tab" data-bs-toggle="pill" data-bs-target="#preprocessing" type="button" role="tab">
                                <i class="fas fa-broom"></i> 数据清洗
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="standardization-tab" data-bs-toggle="pill" data-bs-target="#standardization" type="button" role="tab">
                                <i class="fas fa-balance-scale"></i> 数据标准化
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="analysis-tab" data-bs-toggle="pill" data-bs-target="#analysis" type="button" role="tab">
                                <i class="fas fa-chart-bar"></i> 统计分析
                            </button>
                        </li>
                    </ul>

                    <!-- 功能内容 -->
                    <div class="tab-content" id="functionTabContent">
                        <!-- 数据清洗 -->
                        <div class="tab-pane fade show active" id="preprocessing" role="tabpanel">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="function-card">
                                        <h5><i class="fas fa-exclamation-triangle"></i> 缺失值处理</h5>
                                        <select class="form-select mb-3" id="missingMethod">
                                            <option value="drop">删除含缺失值的行</option>
                                            <option value="fill_mean">用均值填充</option>
                                            <option value="fill_median">用中位数填充</option>
                                            <option value="fill_value">用指定值填充</option>
                                        </select>
                                        <div class="mb-3" id="fillValueDiv" style="display: none;">
                                            <label class="form-label">填充值</label>
                                            <input type="number" class="form-control" id="fillValue" step="any">
                                        </div>
                                        <button class="btn btn-custom w-100" onclick="processMissingValues()">
                                            <i class="fas fa-play"></i> 执行处理
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="function-card">
                                        <h5><i class="fas fa-search"></i> 异常值处理</h5>
                                        <select class="form-select mb-3" id="outlierMethod">
                                            <option value="iqr">IQR方法</option>
                                            <option value="zscore">Z-score方法</option>
                                        </select>
                                        <div class="mb-3" id="thresholdDiv" style="display: none;">
                                            <label class="form-label">Z-score阈值</label>
                                            <input type="number" class="form-control" id="zThreshold" value="3" step="0.1">
                                        </div>
                                        <button class="btn btn-custom w-100" onclick="processOutliers()">
                                            <i class="fas fa-play"></i> 执行处理
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="function-card">
                                        <h5><i class="fas fa-copy"></i> 重复值处理</h5>
                                        <p class="text-muted">自动检测并删除重复的行</p>
                                        <button class="btn btn-custom w-100" onclick="processDuplicates()">
                                            <i class="fas fa-play"></i> 执行处理
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 数据标准化 -->
                        <div class="tab-pane fade" id="standardization" role="tabpanel">
                            <div class="row justify-content-center">
                                <div class="col-md-6">
                                    <div class="function-card">
                                        <h5><i class="fas fa-ruler"></i> 数据标准化</h5>
                                        <select class="form-select mb-3" id="standardizationMethod">
                                            <option value="zscore">Z-score标准化</option>
                                            <option value="minmax">Min-Max标准化</option>
                                        </select>
                                        <div class="mb-3">
                                            <small class="text-muted">
                                                Z-score: (x - μ) / σ<br>
                                                Min-Max: (x - min) / (max - min)
                                            </small>
                                        </div>
                                        <button class="btn btn-custom w-100" onclick="processStandardization()">
                                            <i class="fas fa-play"></i> 执行标准化
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 统计分析 -->
                        <div class="tab-pane fade" id="analysis" role="tabpanel">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="function-card">
                                        <h5><i class="fas fa-project-diagram"></i> 相关性分析</h5>
                                        <p class="text-muted">分析数值列之间的相关性</p>
                                        <button class="btn btn-custom w-100" onclick="processCorrelation()">
                                            <i class="fas fa-play"></i> 执行分析
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="function-card">
                                        <h5><i class="fas fa-calculator"></i> t检验</h5>
                                        <div class="mb-3">
                                            <label class="form-label">第一列</label>
                                            <select class="form-select" id="tTestColumn1">
                                                <option value="">选择列</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">检验类型</label>
                                            <select class="form-select" id="tTestType">
                                                <option value="two_sample">双样本检验</option>
                                                <option value="one_sample">单样本检验</option>
                                            </select>
                                        </div>
                                        <div class="mb-3" id="tTestColumn2Div">
                                            <label class="form-label">第二列</label>
                                            <select class="form-select" id="tTestColumn2">
                                                <option value="">选择列</option>
                                            </select>
                                        </div>
                                        <div class="mb-3" id="tTestValueDiv" style="display: none;">
                                            <label class="form-label">检验值</label>
                                            <input type="number" class="form-control" id="tTestValue" step="any">
                                        </div>
                                        <button class="btn btn-custom w-100" onclick="processTTest()">
                                            <i class="fas fa-play"></i> 执行检验
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="function-card">
                                        <h5><i class="fas fa-th"></i> 卡方检验</h5>
                                        <div class="mb-3">
                                            <label class="form-label">第一列</label>
                                            <select class="form-select" id="chiSquareColumn1">
                                                <option value="">选择列</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">第二列</label>
                                            <select class="form-select" id="chiSquareColumn2">
                                                <option value="">选择列</option>
                                            </select>
                                        </div>
                                        <button class="btn btn-custom w-100" onclick="processChiSquare()">
                                            <i class="fas fa-play"></i> 执行检验
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 加载提示 -->
            <div id="loading" class="hidden text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">处理中...</span>
                </div>
                <p class="mt-3">正在处理数据，请稍候...</p>
            </div>

            <!-- 结果显示 -->
            <div id="result-section" class="hidden">
                <div class="container">
                    <div id="resultMessage"></div>
                    
                    <div id="downloadSection" class="text-center mb-4">
                        <button class="btn btn-success btn-lg" onclick="downloadResult()">
                            <i class="fas fa-download"></i> 下载处理后的Excel文件
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <h5><i class="fas fa-code"></i> 完整Python代码</h5>
                        <div class="d-flex justify-content-end mb-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="copyCode()">
                                <i class="fas fa-copy"></i> 复制代码
                            </button>
                        </div>
                        <div class="code-display" id="pythonCode"></div>
                    </div>
                    
                    <div class="text-center">
                        <button class="btn btn-custom" onclick="resetProcessor()">
                            <i class="fas fa-refresh"></i> 处理新文件
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDataInfo = null;

        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            
            fileInput.addEventListener('change', function(e) {
                console.log('File input changed');
                const file = e.target.files[0];
                if (file) {
                    console.log('File selected:', file.name);
                    handleFile(file);
                }
            });
            
            // 添加表单联动事件
            const missingMethod = document.getElementById('missingMethod');
            const outlierMethod = document.getElementById('outlierMethod');
            const tTestType = document.getElementById('tTestType');
            
            if (missingMethod) missingMethod.addEventListener('change', toggleFillValue);
            if (outlierMethod) outlierMethod.addEventListener('change', toggleThreshold);
            if (tTestType) tTestType.addEventListener('change', toggleTTestInputs);
        });

        function handleFile(file) {
            console.log('Processing file:', file.name, file.size);
            
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showAlert('请选择Excel文件 (.xlsx 或 .xls)', 'danger');
                return;
            }
            
            if (file.size > 16 * 1024 * 1024) {
                showAlert('文件大小不能超过16MB', 'danger');
                return;
            }
            
            uploadFile(file);
        }

        function uploadFile(file) {
            console.log('Uploading file...');
            const formData = new FormData();
            formData.append('file', file);
            
            showLoading(true);
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Upload response:', data);
                showLoading(false);
                
                if (data.success) {
                    currentDataInfo = data.data_info;
                    displayDataInfo(data.data_info);
                    populateColumnSelects(data.data_info.columns);
                    showSection('data-info-section');
                    showSection('functions-section');
                    hideSection('upload-section');
                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                showLoading(false);
                showAlert('上传失败：' + error.message, 'danger');
            });
        }

        function displayDataInfo(dataInfo) {
            const dataInfoDiv = document.getElementById('dataInfo');
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-table"></i> 基本信息</h6>
                        <p><strong>数据形状：</strong> ${dataInfo.shape[0]} 行 × ${dataInfo.shape[1]} 列</p>
                        <p><strong>列名：</strong> ${dataInfo.columns.join(', ')}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-exclamation-circle"></i> 缺失值统计</h6>
            `;
            
            const missingValues = dataInfo.missing_values;
            let hasMissing = false;
            for (const [col, count] of Object.entries(missingValues)) {
                if (count > 0) {
                    html += `<p><strong>${col}：</strong> ${count} 个缺失值</p>`;
                    hasMissing = true;
                }
            }
            
            if (!hasMissing) {
                html += '<p class="text-success">无缺失值</p>';
            }
            
            html += `
                    </div>
                </div>
                <div class="mt-3">
                    <h6><i class="fas fa-eye"></i> 数据预览 (前5行)</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
            `;
            
            // 表头
            dataInfo.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // 数据行
            dataInfo.sample_data.forEach(row => {
                html += '<tr>';
                dataInfo.columns.forEach(col => {
                    const value = row[col];
                    html += `<td>${value !== null && value !== undefined && value !== 'null' ? value : '<span class="text-muted">null</span>'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div>';
            dataInfoDiv.innerHTML = html;
        }

        function populateColumnSelects(columns) {
            const selects = [
                'tTestColumn1', 'tTestColumn2', 
                'chiSquareColumn1', 'chiSquareColumn2'
            ];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">选择列</option>';
                    
                    columns.forEach(col => {
                        const option = document.createElement('option');
                        option.value = col;
                        option.textContent = col;
                        select.appendChild(option);
                    });
                }
            });
        }

        // 表单联动函数
        function toggleFillValue() {
            const method = document.getElementById('missingMethod').value;
            const fillValueDiv = document.getElementById('fillValueDiv');
            if (fillValueDiv) {
                fillValueDiv.style.display = method === 'fill_value' ? 'block' : 'none';
            }
        }

        function toggleThreshold() {
            const method = document.getElementById('outlierMethod').value;
            const thresholdDiv = document.getElementById('thresholdDiv');
            if (thresholdDiv) {
                thresholdDiv.style.display = method === 'zscore' ? 'block' : 'none';
            }
        }

        function toggleTTestInputs() {
            const testType = document.getElementById('tTestType').value;
            const column2Div = document.getElementById('tTestColumn2Div');
            const valueDiv = document.getElementById('tTestValueDiv');
            
            if (testType === 'two_sample') {
                if (column2Div) column2Div.style.display = 'block';
                if (valueDiv) valueDiv.style.display = 'none';
            } else {
                if (column2Div) column2Div.style.display = 'none';
                if (valueDiv) valueDiv.style.display = 'block';
            }
        }

        // 数据处理函数
        function processMissingValues() {
            const method = document.getElementById('missingMethod').value;
            const fillValue = document.getElementById('fillValue').value;
            
            const params = { method };
            if (method === 'fill_value' && fillValue !== '') {
                params.fill_value = parseFloat(fillValue);
            }
            
            processData('missing_values', params);
        }

        function processOutliers() {
            const method = document.getElementById('outlierMethod').value;
            const threshold = document.getElementById('zThreshold').value;
            
            const params = { method };
            if (method === 'zscore') {
                params.threshold = parseFloat(threshold);
            }
            
            processData('outliers', params);
        }

        function processDuplicates() {
            processData('duplicates', {});
        }

        function processStandardization() {
            const method = document.getElementById('standardizationMethod').value;
            processData('standardization', { method });
        }

        function processCorrelation() {
            processData('correlation', {});
        }

        function processTTest() {
            const column1 = document.getElementById('tTestColumn1').value;
            const testType = document.getElementById('tTestType').value;
            
            if (!column1) {
                showAlert('请选择第一列', 'warning');
                return;
            }
            
            const params = { column1 };
            
            if (testType === 'two_sample') {
                const column2 = document.getElementById('tTestColumn2').value;
                if (!column2) {
                    showAlert('请选择第二列', 'warning');
                    return;
                }
                params.column2 = column2;
            } else {
                const value = document.getElementById('tTestValue').value;
                if (value === '') {
                    showAlert('请输入检验值', 'warning');
                    return;
                }
                params.value = parseFloat(value);
            }
            
            processData('t_test', params);
        }

        function processChiSquare() {
            const column1 = document.getElementById('chiSquareColumn1').value;
            const column2 = document.getElementById('chiSquareColumn2').value;
            
            if (!column1 || !column2) {
                showAlert('请选择两列进行卡方检验', 'warning');
                return;
            }
            
            processData('chi_square', { column1, column2 });
        }

        function processData(operation, parameters) {
            showLoading(true);
            hideSection('result-section');
            
            fetch('/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    operation: operation,
                    parameters: parameters
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                displayResult(data);
            })
            .catch(error => {
                showLoading(false);
                showAlert('处理失败：' + error.message, 'danger');
            });
        }

        function displayResult(data) {
            const resultSection = document.getElementById('result-section');
            const resultMessage = document.getElementById('resultMessage');
            const pythonCode = document.getElementById('pythonCode');
            const downloadSection = document.getElementById('downloadSection');
            
            const messageClass = data.success ? 'result-success' : 'result-error';
            resultMessage.innerHTML = `<div class="${messageClass}">${data.message}</div>`;
            
            pythonCode.textContent = data.complete_code;
            
            downloadSection.style.display = data.can_download ? 'block' : 'none';
            
            showSection('result-section');
            
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadResult() {
            window.location.href = '/download';
        }

        function copyCode() {
            const codeElement = document.getElementById('pythonCode');
            const textArea = document.createElement('textarea');
            textArea.value = codeElement.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            showAlert('代码已复制到剪贴板', 'success');
        }

        function resetProcessor() {
            fetch('/reset', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentDataInfo = null;
                    hideSection('data-info-section');
                    hideSection('functions-section');
                    hideSection('result-section');
                    showSection('upload-section');
                    
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput) fileInput.value = '';
                    
                    showAlert(data.message, 'success');
                }
            });
        }

        function showSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) section.classList.remove('hidden');
        }

        function hideSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) section.classList.add('hidden');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }
    </script>
</body>
</html>
